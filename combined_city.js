// const cars = [{"latitude": 40.7275413, "car_id": "100007629661185", "longitude": -74.03919239999999}, {"latitude": 42.0041994, "car_id": "100007784301185", "longitude": -87.67152699999997}, {"latitude": 33.9311835, "car_id": "100007678771185", "longitude": -118.3716698}, {"latitude": 39.804696, "car_id": "100007753861185", "longitude": -104.68660499999999}, {"latitude": 37.7320551, "car_id": "100007581611185-CARSHARE", "longitude": -122.40397239999999}, {"latitude": 37.7924137, "car_id": "100006721291185", "longitude": -122.42972889999999}, {"latitude": 33.9767549, "car_id": "100007743111186", "longitude": -118.41603629999997}, {"latitude": 33.7874567, "car_id": "100007560301187", "longitude": -118.13666619999998}, {"latitude": 37.7618459, "car_id": "100006372131185", "longitude": -122.4119475}, {"latitude": 38.9117142, "car_id": "100007724981185-CARSHARE", "longitude": -77.0310197}, {"latitude": 32.7630805, "car_id": "100007590611185-CARSHARE", "longitude": -117.11714549999999}, {"latitude": 33.931188, "car_id": "100007706781185", "longitude": -118.37166259999998}, {"latitude": 37.799392, "car_id": "100007535731185", "longitude": -122.411722}, {"latitude": 37.5891776, "car_id": "100007479361185", "longitude": -122.34394199999997}, {"latitude": 42.32956, "car_id": "100007734611185", "longitude": -71.09012050000001}, {"latitude": 34.0924412, "car_id": "100007702471186", "longitude": -118.3404774}, {"latitude": 38.8801381, "car_id": "100007674021185", "longitude": -76.9868401}, {"latitude": 32.7257442, "car_id": "100007693481185-CARSHARE", "longitude": -117.19505850000002}, {"latitude": 41.926848, "car_id": "100007560631185", "longitude": -87.71312449999999}, {"latitude": 34.0164752, "car_id": "100007540481185", "longitude": -118.48000430000002}, {"latitude": 41.965582, "car_id": "100006246661186", "longitude": -87.65679460000001}, {"latitude": 37.7748962, "car_id": "100007590001185", "longitude": -122.4896162}, {"latitude": 33.9308591, "car_id": "100007719181185-CARSHARE", "longitude": -118.37675999999999}, {"latitude": 25.7891536, "car_id": "100008005461185", "longitude": -80.1903944}, {"latitude": 42.3702104, "car_id": "100007657991185", "longitude": -71.03176210000004}, {"latitude": 47.6980827, "car_id": "100007649811185", "longitude": -122.34927859999999}, {"latitude": 37.6740026, "car_id": "100007691161186", "longitude": -122.1549607}, {"latitude": 34.0804834, "car_id": "100007761351185", "longitude": -118.3482593}, {"latitude": 37.7785252, "car_id": "100007547781185-CARSHARE", "longitude": -122.42312559999999}, {"latitude": 37.7623216, "car_id": "100003967629190", "longitude": -122.3986615}, {"latitude": 33.9285703, "car_id": "100007733791185", "longitude": -118.3767545}, {"latitude": 41.7743517, "car_id": "100007744041185", "longitude": -87.59332010000003}, {"latitude": 37.347315, "car_id": "100007747061185", "longitude": -121.89540699999998}, {"latitude": 38.8029992, "car_id": "100007673221185", "longitude": -77.16046949999998}, {"latitude": 37.71400920000001, "car_id": "100007523201185-CARSHARE", "longitude": -122.48307720000003}, {"latitude": 33.9311835, "car_id": "100007678481185", "longitude": -118.3716698}, {"latitude": 32.7834115, "car_id": "100007667481185", "longitude": -117.2066345}, {"latitude": 37.491401, "car_id": "100007755981185", "longitude": -122.25854270000002}, {"latitude": 41.8305009, "car_id": "100007468101185", "longitude": -87.62080979999996}, {"latitude": 47.5431725, "car_id": "100007639001185", "longitude": -122.28717949999998}, {"latitude": 25.773593, "car_id": "100007627101185", "longitude": -80.19060139999999}, {"latitude": 41.89135450000001, "car_id": "100007971231185", "longitude": -87.67141040000001}, {"latitude": 37.765043, "car_id": "100004736671187", "longitude": -122.39452900000003}, {"latitude": 39.9124332, "car_id": "100007621211185", "longitude": -75.18399779999999}, {"latitude": 41.903107, "car_id": "100007720051185", "longitude": -87.64356800000002}, {"latitude": 37.4151898, "car_id": "100007777291185", "longitude": -121.94655560000001}, {"latitude": 42.340974, "car_id": "100007746171185", "longitude": -71.05238839999998}, {"latitude": 37.7777096, "car_id": "100007590701185-CARSHARE", "longitude": -122.4188532}, {"latitude": 33.9295971, "car_id": "100007727921185", "longitude": -118.37829310000001}, {"latitude": 37.779035, "car_id": "100005029281187", "longitude": -122.48713499999997}, {"latitude": 38.9298613, "car_id": "100007717211185-CARSHARE", "longitude": -77.04041230000001}, {"latitude": 34.0299284, "car_id": "100007720061185", "longitude": -118.42153989999997}, {"latitude": 34.0915405, "car_id": "100007721061185-CARSHARE", "longitude": -118.36813189999998}, {"latitude": 33.9311835, "car_id": "100007677941185", "longitude": -118.3716698}, {"latitude": 34.1029575, "car_id": "100007658861185", "longitude": -118.31856570000002}, {"latitude": 37.7452741, "car_id": "100007617791185", "longitude": -122.41612680000003}, {"latitude": 32.7269265, "car_id": "100007989161185", "longitude": -117.19581519999997}, {"latitude": 39.9574429, "car_id": "100007745051185-CARSHARE", "longitude": -75.2007276}, {"latitude": 37.7720264, "car_id": "100007571651185", "longitude": -122.4022822}, {"latitude": 37.5117704, "car_id": "100007690691185", "longitude": -122.30694260000001}, {"latitude": 41.89444839999999, "car_id": "100007647441185", "longitude": -87.66834240000003}, {"latitude": 38.9142544, "car_id": "100006984271188", "longitude": -77.03227090000001}, {"latitude": 37.39934540000001, "car_id": "100007534531185", "longitude": -121.91992399999998}, {"latitude": 37.791226, "car_id": "100006470191185", "longitude": -122.3919664}, {"latitude": 34.065762, "car_id": "100007728941185-CARSHARE", "longitude": -118.24158}, {"latitude": 41.88980189999999, "car_id": "100007731471185", "longitude": -87.63074949999998}, {"latitude": 37.7466188, "car_id": "100007604561186-CARSHARE", "longitude": -122.41895369999997}, {"latitude": 37.6977829, "car_id": "100007730021185", "longitude": -122.48493200000001}, {"latitude": 37.8023884, "car_id": "100007565501185", "longitude": -122.44176979999997}, {"latitude": 32.7269265, "car_id": "100007757741185", "longitude": -117.19581519999997}, {"latitude": 38.937385, "car_id": "100006586501187", "longitude": -77.03204499999998}, {"latitude": 33.9295971, "car_id": "100007739221185", "longitude": -118.37829310000001}, {"latitude": 38.8029992, "car_id": "100007701311185", "longitude": -77.16046949999998}, {"latitude": 34.0476071, "car_id": "100007673391186", "longitude": -118.43474900000001}, {"latitude": 37.804868, "car_id": "100006742611185", "longitude": -122.241939}, {"latitude": 37.799757, "car_id": "100006248531185", "longitude": -122.435192}, {"latitude": 40.7770362, "car_id": "100007739811185", "longitude": -74.0302418}, {"latitude": 33.9770366, "car_id": "100007515271185", "longitude": -118.4173063}, {"latitude": 41.8767152, "car_id": "100007754881185", "longitude": -87.6618269}, {"latitude": 37.7802496, "car_id": "100007506561185", "longitude": -122.4100934}, {"latitude": 42.3960075, "car_id": "100006387531187", "longitude": -71.13233730000002}, {"latitude": 40.7473481, "car_id": "100007775341185", "longitude": -74.0434396}, {"latitude": 37.7582337, "car_id": "100007517751185", "longitude": -122.40890869999998}, {"latitude": 37.8072138, "car_id": "100007584281185-CARSHARE", "longitude": -122.4178928}, {"latitude": 41.95756979999999, "car_id": "100007592411185", "longitude": -87.68708749999996}, {"latitude": 39.9548419, "car_id": "100007651881185", "longitude": -75.13980750000002}, {"latitude": 38.9065912, "car_id": "100007060761188", "longitude": -77.0292121}, {"latitude": 41.8911648, "car_id": "100007649821185", "longitude": -87.6210438}, {"latitude": 37.7593771, "car_id": "100007090101185", "longitude": -122.42932000000002}, {"latitude": 37.8739601, "car_id": "100007598621185-CARSHARE", "longitude": -122.28339890000001}, {"latitude": 34.105002, "car_id": "100007664401186", "longitude": -118.19276179999997}, {"latitude": 37.7842488, "car_id": "100005903371185", "longitude": -122.4544338}, {"latitude": 33.9311835, "car_id": "100007652091185", "longitude": -118.3716698}, {"latitude": 37.769373, "car_id": "100007596561185", "longitude": -122.44651699999997}, {"latitude": 47.619273, "car_id": "100007597731185", "longitude": -122.306894}, {"latitude": 41.8164946, "car_id": "100007780691185", "longitude": -87.64013369999998}, {"latitude": 37.759744, "car_id": "100005067641186", "longitude": -122.50405999999998}, {"latitude": 34.023002, "car_id": "100007773441185", "longitude": -118.46794599999998}, {"latitude": 41.9942726, "car_id": "100007527581185", "longitude": -87.65606889999998}, {"latitude": 34.0348143, "car_id": "100007711471185-CARSHARE", "longitude": -118.48959890000003}, {"latitude": 37.7629637, "car_id": "100006910231194-CARSHARE", "longitude": -122.43551009999999}, {"latitude": 33.9308591, "car_id": "100007719741185-CARSHARE", "longitude": -118.37675999999999}, {"latitude": 37.7684303, "car_id": "100007753421185", "longitude": -122.40705330000003}, {"latitude": 38.9198244, "car_id": "100007662661185", "longitude": -77.02163200000001}, {"latitude": 37.7816647, "car_id": "100007523451185", "longitude": -122.4321387}, {"latitude": 37.736013, "car_id": "100007616601185", "longitude": -122.42302469999998}, {"latitude": 33.9295971, "car_id": "100007668501185", "longitude": -118.37829310000001}, {"latitude": 37.7500663, "car_id": "100008005171185", "longitude": -122.47754259999999}, {"latitude": 37.7782313, "car_id": "100007110571189", "longitude": -122.42357570000001}, {"latitude": 37.7678054, "car_id": "100006250401185", "longitude": -122.43018799999999}, {"latitude": 38.8029992, "car_id": "100007671221185", "longitude": -77.16046949999998}, {"latitude": 39.76985190000001, "car_id": "100007749341185", "longitude": -104.78560920000001}, {"latitude": 38.9695568, "car_id": "100007483761185", "longitude": -77.0265612}, {"latitude": 33.9925516, "car_id": "100007784421185", "longitude": -118.47506279999999}, {"latitude": 34.0286204, "car_id": "100007677421185", "longitude": -117.89016270000002}, {"latitude": 41.8927401, "car_id": "100007483331185", "longitude": -87.68468689999997}, {"latitude": 39.7420421, "car_id": "100007727601185", "longitude": -104.9772251}, {"latitude": 41.834718, "car_id": "100007613401186", "longitude": -87.67114199999997}, {"latitude": 40.7163821, "car_id": "100007587461185", "longitude": -74.0359335}, {"latitude": 37.7754465, "car_id": "100007578121185-CARSHARE", "longitude": -122.22559610000002}, {"latitude": 38.8029992, "car_id": "100007714401185", "longitude": -77.16046949999998}, {"latitude": 41.903107, "car_id": "100007691471185", "longitude": -87.64356800000002}, {"latitude": 37.3973807, "car_id": "100007763051185", "longitude": -122.07617670000002}, {"latitude": 37.77090889999999, "car_id": "100007481401185", "longitude": -122.44900180000002}, {"latitude": 38.9030183, "car_id": "100006235791185", "longitude": -77.03813389999999}, {"latitude": 37.3310048, "car_id": "100007615491185-CARSHARE", "longitude": -121.89824529999999}, {"latitude": 37.7944234, "car_id": "100006209381186", "longitude": -122.4217736}, {"latitude": 34.0390333, "car_id": "100007601461186", "longitude": -118.2349443}, {"latitude": 47.6206869, "car_id": "100007762731185", "longitude": -122.30216000000001}];


  let map;

  function initMap () {
    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 8,
      disableDefaultUI: true,
    });
  }


$(document).ready(function() {
  $('#place').val('');
  let start = moment();
  let end = moment();
  const now = moment();
  const MOMENT_FORMAT = 'YYYY-MM-DDTHH:mm:ss.SSS'
  const SHORT_FORMAT = 'YYYY-MM-DD'
  // initialize both datepickers

  const setStartDateAndTime = m => {
    $( "#start-date" ).datepicker("setDate", m.toDate());
    $("#start-time").timepicker('setTime', m.toDate());
    setMinEndAnHourLater();
  }

  const setEndDateAndTime = m => {
    $( "#end-date" ).datepicker("setDate", m.toDate());
    $("#end-time").timepicker('setTime', m.toDate());
    setMinEndAnHourLater();
  }

  const setMinEndAnHourLater = () => {
    if (start.clone().add(1, 'h').isAfter(start.clone().endOf('day')) ||
      start.clone().endOf('day').isSameOrAfter(end.clone().endOf('day'))
  ) {
      $("#end-time").timepicker('option','minTime', start.clone().add(1, 'h').toDate());
    } else {
      $("#end-time").timepicker('option','minTime', 0);
    }
  }

  const roundToNextFifteenMin = min => (Math.ceil(min/15) * 15) % 60;

  const roundUpHour = min => (Math.ceil(min/15) * 15) % 60 ? 0 : 1;

  const aDaHoAftrMdnght = ({ m, h = 0, d = 0, min = 0 }) =>
    m.add(d, 'd')
    .startOf('d')
    .add(h, 'h')
    .add(roundToNextFifteenMin(min), 'm')
    .add(roundUpHour(min), 'h');

  const initializeDatePickers = () => {
    const dotw = now.day();
    const hour = now.hour();

    if (!dotw || dotw === 6) { // is saturday or sunday
      if (hour > 5 && hour < 19) { //between 6AM and 6PM
        start = aDaHoAftrMdnght({ m: start, d: 0, h: now.hour() + 1, min: now.minutes() });
        end = aDaHoAftrMdnght({ m: end, d: 0, h:  now.hour() + 1 + 12, min: now.minutes()  });
        // should start 1 hour from now
        // should end 12 hours after start
      } else if (dotw === 0 && hour >=19) {
        start = aDaHoAftrMdnght({ m: start, d: 1, h: 9 });
        end = aDaHoAftrMdnght({ m: end, d: 1, h: 9 + 12 });
        // not defined. setting as default
      } else {
        start = aDaHoAftrMdnght({ m: start, d: 1, h: 9 });
        end = aDaHoAftrMdnght({ m: end, d: 1, h:  9 + 12  });
        //should start sunday 10am
        //should end 12 hours after start
      }
    } else if (dotw !==5) { // not friday
      if (hour > 5 && hour < 15) { //between 6 and 2
        start = aDaHoAftrMdnght({ m: start, d: 0, h: now.hour() + 3, min: now.minutes() });
        end = aDaHoAftrMdnght({ m: end, d: 0, h:  now.hour() + 3 + 12, min: now.minutes()  });
        // start is 3 hours from now
        // end is 12 hours after
      } else { //2pm to 6am
        start = aDaHoAftrMdnght({ m: start, d: 1, h: 9 });
        end = aDaHoAftrMdnght({ m: end, d: 1, h: 9 + 12 });
        // start day is next day, time is 9am
        // end 12 hours after start
      }
    } else { // is friday
      if (hour > 5 && hour < 15) { //between 6 and 2
        start = aDaHoAftrMdnght({ m: start, d: 0, h: now.hour() + 3, min: now.minutes() });
        end = aDaHoAftrMdnght({ m: end, d: 0 , h: now.hour() + 3 + 12, min: now.minutes() });
        // start is 3 hours from now
        // end is 12 hours after
      } else { //2pm to 6am
        start = aDaHoAftrMdnght({ m: start, d: 1, h: 9 });
        end = aDaHoAftrMdnght({ m: end, d: 1 , h: 9 + 24 });
        // start day is next day, time is 9am
        // end 24 hours after start
      }
    }
    setStartDateAndTime(start);
    setEndDateAndTime(end);
  }

  const calOpts = {
    minDate: now.toDate(),
    hideIfNoPrevNext: true,
    dateFormat: 'm/d/y',
    // altFormat: 'm/d/y'
  }

  const convertValDateText = valDateText => moment(valDateText, 'M/D/YY').format('MM/DD/YYYY');

  const changeStartDate = valDateText => {
    const dateText = convertValDateText(valDateText)
    const [m, d, y] = dateText.split('/');
    start.set({ 'y': y, 'M': parseInt(m, 10) - 1, 'D': d }); // months are zero indexed
    // change endDateMin

    $( "#end-date" ).datepicker('option', 'minDate', dateText);
    adjustEndTimeAgainstStart()
    setEndDateAndTime(end);
    setStartDateAndTime(start);
    $( "#start-date" ).blur();
  }

  const changeEndDate = valDateText => {
    const dateText = convertValDateText(valDateText)
    const [m, d, y] = dateText.split('/');
    end.set({'y': y, 'M': parseInt(m, 10) - 1, 'D': d}); // months are zero indexed
    adjustEndTimeAgainstStart()
    setEndDateAndTime(end);
  }

  const timepickerOptions = {
    step: 15,
    maxTime: '24:00',
    timeFormat: 'h:i A',
  }

  modEDtAgSt = () => {
    if (start.clone().add(1, 'h').isAfter(start.clone().endOf('day'))) {
      // then we need to push the end, and min end, to the next day
      const minEndDate = start.clone().add(1, 'd');
      $( "#end-date" ).datepicker('option', 'minDate', minEndDate.toDate());
    } else {
      $( "#end-date" ).datepicker('option', 'minDate', start.toDate());
    }
  }

  const adjustEndTimeAgainstStart = () => {
    if (start.clone().add(1, 'h').isAfter(end)) {
      end.set({h: start.hour() + 1, m: start.minutes()})
    }
    if (start.day() === 5) { // is friday, so set default start time to 48 hours ahead
      end.set({D: start.date() + 2, h: start.hour(), m: start.minutes()})
    }
    modEDtAgSt()
  }

  const changeStartTime = (e) => {
    e.preventDefault();
    const newStartTime = moment($('#start-time').timepicker('getTime'));
    const h = newStartTime.hours();
    const m = newStartTime.minutes();
    start.set({h, m});
    adjustEndTimeAgainstStart()

    setEndDateAndTime(end);
    setStartDateAndTime(start);
  }

  $( "#end-date" ).datepicker({...calOpts, onSelect: changeEndDate });
  $( "#start-date" ).datepicker({ ...calOpts, onSelect: changeStartDate });
  $( "#end-time" ).timepicker(timepickerOptions);
  $( "#start-time" ).timepicker(timepickerOptions);
  $( "#start-time" ).on('change', changeStartTime);
  initializeDatePickers();

  // add default viewport
  this.viewport;
  // mapViewport is used for mapview, and simple search
  this.mapViewport;

  this.urlPort = window.location.port;
  let urlHostName = window.location.hostname;
  if (urlHostName == "w.getaround.com" || urlHostName == "getaround.webflow.io" || !urlHostName || urlHostName === '' ) {
      urlHostName = "www.getaround.com"
  }
  const pageHost = urlHostName;
  if (this.urlPort !== "") {
      this.urlHostName += ":";
  }

  // google maps stuff
  const input = $('#place')[0];
  const input2 = $('#search-place')[0];

  const autocomplete = new google.maps.places.Autocomplete(input);
  const autocomplete2 = new google.maps.places.Autocomplete(input2);

  const assignViewportToSearch = (vp, isMap) => {
    const vpS = `${vp.ma.j},${vp.ga.j},${vp.ma.l},${vp.ga.l}`;
    if (isMap) {
      this.mapViewport = vpS;
    } else {
      this.viewport = vpS;
    }
  }

  this.placesChangedHandler = () => {
      var place = autocomplete.getPlace();
      if (!place.geometry) {
        // User entered the name of a Place that was not suggested and
        // pressed the Enter key, or the Place Details request failed.
        window.alert("No details available for input: '" + place.name + "'");
      } else {
        if (place.geometry.viewport) {
          const vp = place.geometry.viewport;
          assignViewportToSearch(vp);
        } else {
          window.alert("No details available for input: '" + place.name + "'");
        }
      }
    }

  autocomplete.setFields(['address_components', 'geometry','name']);
  autocomplete2.setFields(['address_components', 'geometry','name']);
  autocomplete.addListener('place_changed', this.placesChangedHandler);
  autocomplete2.addListener('place_changed', this.placesChangedHandler);

  this.getSearchParams = (useMapVP) => {
    const end_time = `end_time=${end.format(MOMENT_FORMAT)}`;
    const start_time = `start_time=${start.format(MOMENT_FORMAT)}`;
    const use = 'use=CARSHARE';
    const viewport = `viewport=${useMapVP ? this.mapViewport : this.viewport}`;
    return `${start_time}&${end_time}&${use}&${viewport}`;
  }
  this.redirectToSearch = e => {
    e.preventDefault();
    const { mvp } = e.data ? e.data : {mvp: false};
    const searchParams = this.getSearchParams(mvp);
    window.location.href = `https://www.getaround.com/search?${searchParams}`;
  }
  $("#submit-search").on("click", this.redirectToSearch, {mvp: true});
  $(".btn.search-inputs").on("click", this.redirectToSearch, {mvp: true});
  $("#map").click(this.redirectToSearch);

  const recenterMapOnCity = (viewport) => {
    map.fitBounds(viewport);
  }

  let geocoder;

  const getLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    }
  }

  const showPosition = position => {
    codeLatLng(position.coords.latitude, position.coords.longitude);
  }

  const codeLatLng = (lat, lng) => {
    var latlng = new google.maps.LatLng(lat, lng);
    geocoder.geocode({
      'latLng': latlng
    }, function (results, status) {
      if (status === google.maps.GeocoderStatus.OK) {
        if (results[1]) {
          autocomplete.set("place", results[1])
          $('#place').val(results[1].formatted_address);
          setTimeout(() => $('#place').blur(), 1000);
        } else {
          // no results found at current location
        }
      } else {
        // browser did not allow location services
      }
    });
  }

  const icon = {
    url: 'https://www.getaround.com/img/icons/map_marker_pin.png',
    scaledSize: new google.maps.Size(20,30)
  }

  const populateMapWithCars = carList => {
    const markers = carList.map(car =>
      new google.maps.Marker({
        position: {
          lat: car.latitude,
          lng: car.longitude,
        },
        icon,
        map: map,
      }));

      var markerCluster = new MarkerClusterer(map, markers,
            {
              styles: [
                {
                  url: 'https://uploads-ssl.webflow.com/5c16e90c8f6920b098f834e5/5c9b4968cce07f0b92f0e020_map_marker_pin_multi.png',
                  height: 26,
                  width: 18,
                  textColor: 'rgba(0,0,0,0)'
                },
              ],
              gridSize: 10,

            });

  }

  const makeCarApiRequest = (backupUrl) => {
    let url = backupUrl || `https://index.getaround.com/v1.0/search`;
    const params = {
      start_time: start.format(MOMENT_FORMAT),
      end_time: end.format(MOMENT_FORMAT),
      viewport: this.mapViewport,
    }
    url = `${url}?product=web&viewport=${this.mapViewport}&use=CARSHARE`;
    fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data && data.cars) {
        populateMapWithCars(data.cars)
      }
    }).catch(() => backupUrl ? console.error() : makeCarApiRequest(`https://index.g3staging.getaround.com/v1.0/search`))
  }




  const getCityViewport = () => {

    const urlCityList = [
      {url: 'atlanta-car-rental', city: 'Atlanta, GA'},
      {url: 'berkeley-car-rental', city: 'Berkeley, CA'},
      {url: 'boston-car-rental', city: 'Boston, MA'},
      {url: 'chicago-car-rental', city: 'Chicago, IL'},
      {url: 'denver-car-rental', city: 'Denver, CO'},
      {url: 'los-angeles-car-rental', city: 'Los Angeles, CA'},
      {url: 'miami-car-rental', city: 'Miami, FL'},
      {url: 'new-jersey-car-rental', city: 'Jersey City, NJ'},
      {url: 'new-york-car-rental', city: 'New York City, NY'},
      {url: 'oakland-car-rental', city: 'Oakland, CA'},
      {url: 'philadelphia-car-rental', city: 'Philadelphia, PA'},
      {url: 'portland-car-rental', city: 'Portland, OR'},
      {url: 'san-diego-car-rental', city: 'San Diego, CA'},
      {url: 'san-francisco-car-rental', city: 'San Francisco, CA'},
      {url: 'seattle-car-rental', city: 'Seattle, WA'},
      {url: 'washington-dc-car-rental', city: 'Washington, D.C.'},
    ];
    const url = window.location.href;
    const last = url.split('/')[url.split('/').length - 1];
    const { city } = urlCityList.find(i => last.search(i.url) > -1) || { city: 'San Francisco, CA' };
    var request = {
        query: city,
        fields: ['geometry'],
      };

      $('#search-place').val(city);

      var service = new google.maps.places.PlacesService(document.createElement('div'));

      service.findPlaceFromQuery(request, function(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          const viewport = results[0].geometry.viewport;
          assignViewportToSearch(viewport, true);
          recenterMapOnCity(viewport);
          makeCarApiRequest();
        }
      });
  }

  const initialize = () => {
    geocoder = new google.maps.Geocoder();
    getLocation();
    getCityViewport();
  }
  initialize();
  const REVIEW_MOMENT_FORMAT = 'MMMM Do, YYYY';
  const MD = 768;
  const SM = 576;

  const width = () => $( window ).width();

  const apiUrl = 'https://us-central1-getaround3.cloudfunctions.net/api';

  const getNum = () => {
    if (width() > MD) {
      return 4;
    }
    if (width() > SM) {
      return 3;
    }
    return 1;
  }

  this.num = getNum();
  this.offset = 2 * getNum();
  this.reviews = [];

  const populateReviewsItem = (newReviews) => {
    if (this.offset > 19 && newReviews.length) {
      const children = $('#reviews-wrapper').children();
      let i = 0;
      while (i < getNum() && newReviews[i]) {
        children[i].remove();
        i++;
      }
    }

    if (newReviews && newReviews.length) {
      const cards = newReviews.map(review =>
        `<div class="col-12 col-md-4 col-lg-3 card-wrapper"><div class="card"><div class="card-body"><div class="card-title d-flex"><h5 class="col-9">${review.name}<br /><span>${moment(review.date).format(REVIEW_MOMENT_FORMAT)}</span></h5>
  <div class="col-3" style="background-image: url(${review['persona-image'].url})" />
</div>
  <div class="row stars-holder">
    ${[...Array(4)].map((e, i) => '<i class="fas fa-star" />').join('')}
  </div>
  <p class="card-text">
    ${review.comment}
  </p>
</div>
  </div>
<div>`
      )
      $('#reviews-wrapper').append(cards)
    }
  }

  const fetchItems = ({ num = 8, offset = 0 } = {}) => {
    fetch(`${apiUrl}/collections/5c1c459d6f08bd4d33d101ac?num=${num}&offset=${offset}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.items) {
        this.reviews = this.reviews.concat(data.items);
        populateReviewsItem(data.items);
      }
    })
    .catch(console.error)
    .catch(console.error);
  }

  this.cars = [];

  const toShow = () => {
    if (width() < SM) {
      return 1;
    }
    if (width() <= MD) {
      return 2;
    }
    return 4;
  }

  const populateCarsItem = (newCars) => {
    if (newCars && newCars.length) {
      $("#carousel").slick({
        slidesToShow: toShow(),
        centerMode: width() <= MD,
        arrows: width() > SM,
        nextArrow: '<i class="arrow fas fa-chevron-right fa-2x" ></i>',
        prevArrow: '<i class="arrow fas fa-chevron-left fa-2x" ></i>',
        // autoplay: true,
      });
      newCars.forEach(car => {
        $("#carousel").slick('slickAdd',`
        <div class="wrapper">
          <div class="item">
            <div class="bg-img" style="background-image: url(${car['car-photo'].url})" />
            <div class="caption">
              <h3>${car.name}</h3>
              <p>from $${car.price}/hr</p>
              <a href='https://${car['car-url']}'>${car.name}</a>
            </div>
          </div>
        </div>
        `);
      }
      )
    }
  }

  const fetchCars = ({ num = 12, offset = 0 } = {}) => {
    fetch(`${apiUrl}/collections/5c913f3b0b45a005abe59251?num=${num}&offset=${offset}`)
    .then(res => res.json())
    .then(data => {
      if (data && data.items) {
        this.cars = this.cars.concat(data.items);
        populateCarsItem(data.items);
      }
    })
    .catch(console.error)
    .catch(console.error);
  }

  const initData = () => {
    this.cars = [];
    fetchCars({ num: 12 });
    this.reviews = [];
    fetchItems({ num: this.num * 2 });
    this.offset = 2 * getNum();
  }

  const loadMore = () => {
    this.offset = this.offset + getNum();
    fetchItems({ num: this.num, offset: this.offset });
  }

  const resize = () => {
    this.num = getNum();
    this.offset = 2 * getNum();
    const children = $('#reviews-wrapper').children();
    let i;
    for (i = 0; i < children.length; i++) {
      children[i].remove();
    }
    initData();
  }

  $("#load-more").on('click', loadMore);
  $(window).on('resize', () => {
    $("#carousel").slick('unslick');
    const children = $('#carousel').children();
    let i;
    for (i = 0; i < children.length; i++) {
      children[i].remove();
    }
    clearTimeout(window.resizedFinished);
    window.resizedFinished = setTimeout(() => {
      resize();
    }, 250);
  });
  initData();
});
